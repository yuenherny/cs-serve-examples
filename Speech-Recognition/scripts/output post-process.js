var probabilities = msg.output[0];
function listToMatrix(list, elementsPerSubArray) {
    var matrix = [], i, k;
    for (i = 0, k = -1; i < list.length; i++) {
        if (i % elementsPerSubArray === 0) {
            k++;
            matrix[k] = [];
        }
        matrix[k].push(list[i]);
    }
    return matrix;
}
var probabilities_matrix;
probabilities_matrix = listToMatrix(probabilities,999);
var frames = probabilities_matrix.length;
function indexOfMax(arr) {
    if (arr.length === 0) {
        return -1;
    }
    var max = arr[0];
    var maxIndex = 0;
    for (var i = 1; i < arr.length; i++) {
        if (arr[i] > max) {
            maxIndex = i;
            max = arr[i];
        }
    }
    return maxIndex;
}
var dict = {
  0: "_",
  1: "th", 
  2: "the", 
  3: "in", 
  4: "an", 
  5: "re", 
  6: "er", 
  7: "on", 
  8: "at", 
  9: "ou", 
  10: "is", 
  11: "en", 
  12: "to", 
  13: "and", 
  14: "ed", 
  15: "al", 
  16: "as", 
  17: "it", 
  18: "ing", 
  19: "or", 
  20: "of", 
  21: "es", 
  22: "ar", 
  23: "he", 
  24: "le", 
  25: "st", 
  26: "se", 
  27: "om", 
  28: "ic", 
  29: "be", 
  30: "we", 
  31: "ly", 
  32: "that", 
  33: "no", 
  34: "wh", 
  35: "ve", 
  36: "ha", 
  37: "you", 
  38: "ch", 
  39: "ion", 
  40: "il", 
  41: "ent", 
  42: "ro", 
  43: "me", 
  44: "id", 
  45: "ac", 
  46: "gh", 
  47: "for", 
  48: "was", 
  49: "lo", 
  50: "ver", 
  51: "ut", 
  52: "li", 
  53: "ld", 
  54: "ay", 
  55: "ad", 
  56: "so", 
  57: "ir", 
  58: "im", 
  59: "un", 
  60: "wi", 
  61: "ter", 
  62: "are", 
  63: "with", 
  64: "ke", 
  65: "ge", 
  66: "do", 
  67: "ur", 
  68: "all", 
  69: "ce", 
  70: "ab", 
  71: "mo", 
  72: "go", 
  73: "pe", 
  74: "ne", 
  75: "this", 
  76: "ri", 
  77: "ght", 
  78: "de", 
  79: "one", 
  80: "us", 
  81: "am", 
  82: "out", 
  83: "fe", 
  84: "but", 
  85: "po", 
  86: "his", 
  87: "te", 
  88: "ho", 
  89: "ther", 
  90: "not", 
  91: "con", 
  92: "com", 
  93: "ll", 
  94: "they", 
  95: "if", 
  96: "ould", 
  97: "su", 
  98: "have",
  99: "ct",
  100: "ain", 
  101: "our", 
  102: "ation", 
  103: "fr", 
  104: "ill", 
  105: "now", 
  106: "sa", 
  107: "had", 
  108: "tr", 
  109: "her", 
  110: "per", 
  111: "ant", 
  112: "oun", 
  113: "my", 
  114: "ul", 
  115: "ca", 
  116: "by", 
  117: "what", 
  118: "red", 
  119: "res", 
  120: "od", 
  121: "ome", 
  122: "ess", 
  123: "man", 
  124: "ex", 
  125: "she", 
  126: "pl", 
  127: "co", 
  128: "wor", 
  129: "pro", 
  130: "up", 
  131: "thing", 
  132: "there", 
  133: "ple", 
  134: "ag", 
  135: "can", 
  136: "qu", 
  137: "art", 
  138: "ally", 
  139: "ok", 
  140: "from", 
  141: "ust", 
  142: "very", 
  143: "sh", 
  144: "ind", 
  145: "est", 
  146: "some", 
  147: "ate", 
  148: "wn", 
  149: "ti", 
  150: "fo", 
  151: "ard", 
  152: "ap", 
  153: "him", 
  154: "were", 
  155: "ich", 
  156: "here", 
  157: "bo", 
  158: "ity", 
  159: "um", 
  160: "ive", 
  161: "ous", 
  162: "way", 
  163: "end", 
  164: "ig", 
  165: "pr", 
  166: "which", 
  167: "ma", 
  168: "ist", 
  169: "them", 
  170: "like", 
  171: "who", 
  172: "ers", 
  173: "when", 
  174: "act", 
  175: "use", 
  176: "about", 
  177: "ound", 
  178: "gr", 
  179: "et", 
  180: "ide", 
  181: "ight", 
  182: "ast", 
  183: "king", 
  184: "would", 
  185: "ci", 
  186: "their", 
  187: "other", 
  188: "see", 
  189: "ment", 
  190: "ong", 
  191: "wo", 
  192: "ven", 
  193: "know", 
  194: "how", 
  195: "said", 
  196: "ine", 
  197: "ure", 
  198: "more", 
  199: "der", 
  200: "sel", 
  201: "br", 
  202: "ren", 
  203: "ack", 
  204: "ol", 
  205: "ta", 
  206: "low", 
  207: "ough", 
  208: "then", 
  209: "peo", 
  210: "ye", 
  211: "ace", 
  212: "people", 
  213: "ink", 
  214: "ort", 
  215: "your", 
  216: "will", 
  217: "than", 
  218: "pp", 
  219: "any", 
  220: "ish", 
  221: "look", 
  222: "la", 
  223: "just", 
  224: "tor", 
  225: "ice", 
  226: "itt", 
  227: "af", 
  228: "these", 
  229: "sp", 
  230: "has", 
  231: "gre", 
  232: "been", 
  233: "ty", 
  234: "ies", 
  235: "ie", 
  236: "get", 
  237: "able", 
  238: "day", 
  239: "could", 
  240: "bl", 
  241: "two", 
  242: "time", 
  243: "beca", 
  244: "into", 
  245: "age", 
  246: "ans", 
  247: "mis", 
  248: "new", 
  249: "ree", 
  250: "ble", 
  251: "ite", 
  252: "si", 
  253: "urn", 
  254: "ass", 
  255: "cl", 
  256: "ber", 
  257: "str", 
  258: "think", 
  259: "dis", 
  260: "mar", 
  261: "ence", 
  262: "pt", 
  263: "self", 
  264: "ated", 
  265: "did", 
  266: "el", 
  267: "don", 
  268: "ck", 
  269: "ph", 
  270: "ars", 
  271: "ach", 
  272: "fore", 
  273: "its", 
  274: "part", 
  275: "ang", 
  276: "cre", 
  277: "well", 
  278: "ions", 
  279: "where", 
  280: "ves", 
  281: "ved", 
  282: "em", 
  283: "good", 
  284: "because", 
  285: "over", 
  286: "ud", 
  287: "ts", 
  288: "off", 
  289: "turn", 
  290: "cr", 
  291: "right", 
  292: "ress", 
  293: "most", 
  294: "every", 
  295: "pre", 
  296: "fa", 
  297: "fir", 
  298: "ild", 
  299: "pos", 
  300: "down", 
  301: "work", 
  302: "ade", 
  303: "say", 
  304: "med", 
  305: "also", 
  306: "litt", 
  307: "little", 
  308: "ance", 
  309: "come", 
  310: "ving", 
  311: "only", 
  312: "ful", 
  313: "ought", 
  314: "want", 
  315: "going", 
  316: "spe", 
  317: "ps", 
  318: "ater", 
  319: "first", 
  320: "after", 
  321: "ue", 
  322: "ose", 
  323: "mu", 
  324: "iz", 
  325: "ire", 
  326: "int", 
  327: "rest", 
  328: "ser", 
  329: "coun", 
  330: "des", 
  331: "light", 
  332: "son", 
  333: "let", 
  334: "ical", 
  335: "ick", 
  336: "ra", 
  337: "back", 
  338: "mon", 
  339: "ase", 
  340: "ign", 
  341: "ep", 
  342: "world", 
  343: "may", 
  344: "read", 
  345: "form", 
  346: "much", 
  347: "even", 
  348: "should", 
  349: "again", 
  350: "make", 
  351: "long", 
  352: "sto", 
  353: "cont", 
  354: "put", 
  355: "thr", 
  356: "under", 
  357: "cor", 
  358: "bet", 
  359: "jo", 
  360: "car", 
  361: "ile", 
  362: "went", 
  363: "yes", 
  364: "ually", 
  365: "row", 
  366: "hand", 
  367: "ak", 
  368: "call", 
  369: "ary", 
  370: "ia", 
  371: "many", 
  372: "cho", 
  373: "things", 
  374: "try", 
  375: "gl", 
  376: "ens", 
  377: "really", 
  378: "happ", 
  379: "great", 
  380: "dif", 
  381: "bu", 
  382: "hi", 
  383: "made", 
  384: "room", 
  385: "ange", 
  386: "cent", 
  387: "ious", 
  388: "je", 
  389: "three", 
  390: "ward", 
  391: "op", 
  392: "gen", 
  393: "those", 
  394: "life", 
  395: "tal", 
  396: "pa", 
  397: "through", 
  398: "und", 
  399: "cess", 
  400: "before", 
  401: "du", 
  402: "side", 
  403: "need", 
  404: "less", 
  405: "inter", 
  406: "ting", 
  407: "ry", 
  408: "ise", 
  409: "na", 
  410: "men", 
  411: "ave", 
  412: "fl", 
  413: "ction", 
  414: "pres", 
  415: "old", 
  416: "something", 
  417: "miss", 
  418: "never", 
  419: "got", 
  420: "feren", 
  421: "imp", 
  422: "sy", 
  423: "ations", 
  424: "tain", 
  425: "ning", 
  426: "ked", 
  427: "sm", 
  428: "take", 
  429: "ten", 
  430: "ted", 
  431: "ip", 
  432: "col", 
  433: "own", 
  434: "stand", 
  435: "add", 
  436: "min", 
  437: "wer", 
  438: "ms", 
  439: "ces", 
  440: "gu", 
  441: "land", 
  442: "bod", 
  443: "log", 
  444: "cour", 
  445: "ob", 
  446: "vo", 
  447: "ition", 
  448: "hu", 
  449: "came", 
  450: "comp", 
  451: "cur", 
  452: "being", 
  453: "comm", 
  454: "years", 
  455: "ily", 
  456: "wom", 
  457: "cer", 
  458: "kind", 
  459: "thought", 
  460: "such", 
  461: "tell", 
  462: "child", 
  463: "nor", 
  464: "bro", 
  465: "ial", 
  466: "pu", 
  467: "does", 
  468: "head", 
  469: "clo", 
  470: "ear", 
  471: "led", 
  472: "llow", 
  473: "ste", 
  474: "ness", 
  475: "too", 
  476: "start", 
  477: "mor", 
  478: "used", 
  479: "par", 
  480: "play", 
  481: "ents", 
  482: "tri", 
  483: "upon", 
  484: "tim", 
  485: "num", 
  486: "ds", 
  487: "ever", 
  488: "cle", 
  489: "ef", 
  490: "wr", 
  491: "vis", 
  492: "ian", 
  493: "sur", 
  494: "same", 
  495: "might", 
  496: "fin", 
  497: "differen", 
  498: "sho", 
  499: "why",
  500: "body", 
  501: "mat", 
  502: "beg", 
  503: "vers", 
  504: "ouse", 
  505: "actually", 
  506: "ft", 
  507: "ath", 
  508: "hel", 
  509: "sha", 
  510: "ating", 
  511: "ual", 
  512: "found", 
  513: "ways", 
  514: "must", 
  515: "four", 
  516: "gi", 
  517: "val", 
  518: "di", 
  519: "tre", 
  520: "still", 
  521: "tory", 
  522: "ates", 
  523: "high", 
  524: "set", 
  525: "care", 
  526: "ced", 
  527: "last", 
  528: "find", 
  529: "au", 
  530: "inte", 
  531: "ev", 
  532: "ger", 
  533: "thank", 
  534: "ss", 
  535: "ict", 
  536: "ton", 
  537: "cal", 
  538: "nat", 
  539: "les", 
  540: "bed", 
  541: "away", 
  542: "place", 
  543: "house", 
  544: "che", 
  545: "ject", 
  546: "sol", 
  547: "another", 
  548: "ited", 
  549: "att", 
  550: "face", 
  551: "show", 
  552: "ner", 
  553: "ken", 
  554: "far", 
  555: "ys", 
  556: "lect", 
  557: "lie", 
  558: "tem", 
  559: "ened", 
  560: "night", 
  561: "while", 
  562: "looking", 
  563: "ah", 
  564: "wal", 
  565: "dr", 
  566: "real", 
  567: "cha", 
  568: "exp", 
  569: "war", 
  570: "five", 
  571: "pol", 
  572: "fri", 
  573: "wa", 
  574: "cy", 
  575: "fect", 
  576: "xt", 
  577: "left", 
  578: "give", 
  579: "soci", 
  580: "cond", 
  581: "char", 
  582: "bor", 
  583: "point", 
  584: "number", 
  585: "mister", 
  586: "called", 
  587: "six", 
  588: "bre", 
  589: "vi", 
  590: "without", 
  591: "person", 
  592: "air", 
  593: "different", 
  594: "lot", 
  595: "bit", 
  596: "pass", 
  597: "ular", 
  598: "youn", 
  599: "won", 
  600: "main", 
  601: "cri", 
  602: "ings", 
  603: "den", 
  604: "water", 
  605: "human", 
  606: "around", 
  607: "quest", 
  608: "ters", 
  609: "ities", 
  610: "feel", 
  611: "each", 
  612: "friend", 
  613: "sub", 
  614: "though", 
  615: "saw", 
  616: "ks", 
  617: "hund", 
  618: "hundred", 
  619: "times", 
  620: "lar", 
  621: "ff", 
  622: "amer", 
  623: "scho", 
  624: "sci", 
  625: "ors", 
  626: "lt", 
  627: "arch", 
  628: "fact", 
  629: "hal", 
  630: "himself", 
  631: "gener", 
  632: "mean", 
  633: "vol", 
  634: "school", 
  635: "ason", 
  636: "fam", 
  637: "ult", 
  638: "mind", 
  639: "itch", 
  640: "ped", 
  641: "home", 
  642: "young", 
  643: "took", 
  644: "big", 
  645: "love", 
  646: "reg", 
  647: "eng", 
  648: "sure", 
  649: "vent", 
  650: "ls", 
  651: "ot", 
  652: "ince", 
  653: "thous", 
  654: "eight", 
  655: "thousand", 
  656: "better", 
  657: "mom", 
  658: "appe", 
  659: "once", 
  660: "ied", 
  661: "mus", 
  662: "stem", 
  663: "sing", 
  664: "ident", 
  665: "als", 
  666: "uh", 
  667: "mem", 
  668: "produ", 
  669: "stud", 
  670: "power", 
  671: "atch", 
  672: "bas", 
  673: "father", 
  674: "av", 
  675: "nothing", 
  676: "gir", 
  677: "pect", 
  678: "unt", 
  679: "few", 
  680: "kes", 
  681: "eyes", 
  682: "sk", 
  683: "always", 
  684: "ared", 
  685: "toge", 
  686: "stru", 
  687: "together", 
  688: "ics", 
  689: "bus", 
  690: "fort", 
  691: "ween", 
  692: "rep", 
  693: "ically", 
  694: "small", 
  695: "ga", 
  696: "mer", 
  697: "ned", 
  698: "ins", 
  699: "between",
  700: "yet", 
  701: "stre", 
  702: "hard", 
  703: "system", 
  704: "course", 
  705: "year", 
  706: "cept", 
  707: "publ", 
  708: "sim", 
  709: "sou", 
  710: "ready", 
  711: "follow", 
  712: "present", 
  713: "rel", 
  714: "turned", 
  715: "sw", 
  716: "possi", 
  717: "mother", 
  718: "io", 
  719: "bar", 
  720: "ished", 
  721: "dec", 
  722: "ments", 
  723: "pri", 
  724:"next", 
  725: "ross", 
  726: "both", 
  727: "ship", 
  728: "ures", 
  729: "americ", 
  730: "eas", 
  731: "asked", 
  732: "iness", 
  733: "serv", 
  734: "ists", 
  735: "ash", 
  736: "uni", 
  737: "build", 
  738: "phone", 
  739: "lau", 
  740: "ctor", 
  741: "belie", 
  742: "change", 
  743: "interest", 
  744: "peri", 
  745: "children", 
  746: "thir", 
  747: "lear", 
  748: "plan", 
  749: "import", 
  750: "ational", 
  751: "har", 
  752: "ines", 
  753: "dist", 
  754: "selves", 
  755: "city", 
  756: "sen", 
  757: "run", 
  758: "law", 
  759: "ghter", 
  760: "proble", 
  761: "woman", 
  762: "done", 
  763: "heart", 
  764: "book", 
  765: "aut", 
  766: "ris", 
  767: "lim", 
  768: "looked", 
  769: "vid", 
  770: "fu", 
  771: "bab", 
  772: "ately", 
  773: "ord", 
  774: "ket", 
  775: "oc", 
  776: "doing", 
  777: "area", 
  778: "tech", 
  779: "win", 
  780: "name", 
  781: "second", 
  782: "certain", 
  783: "pat", 
  784: "lad", 
  785: "quite", 
  786: "told", 
  787: "ific", 
  788: "ative", 
  789: "uring", 
  790: "gg", 
  791: "half", 
  792: "reason", 
  793: "moment", 
  794: "ility", 
  795: "ution", 
  796: "shall", 
  797: "aur", 
  798: "enough", 
  799: "idea", 
  800: "open", 
  801: "understand", 
  802: "vie", 
  803: "contin", 
  804: "mal", 
  805: "hor", 
  806: "qui", 
  807: "address", 
  808: "heard", 
  809: "help", 
  810: "inst", 
  811: "oney", 
  812: "whole", 
  813: "gover", 
  814: "commun", 
  815: "exam", 
  816: "near", 
  817: "didn", 
  818: "logy", 
  819: "oh", 
  820: "tru", 
  821: "lang", 
  822: "restaur", 
  823: "restaurant", 
  824: "design", 
  825: "ze", 
  826: "talk", 
  827: "leg", 
  828: "line", 
  829: "ank", 
  830: "ond", 
  831: "country", 
  832: "ute", 
  833: "howe", 
  834: "hold", 
  835: "live", 
  836: "comple", 
  837: "however", 
  838: "ized", 
  839: "ush", 
  840: "seen", 
  841: "bye", 
  842: "fer", 
  843: "ital", 
  844: "women", 
  845: "net", 
  846: "state", 
  847: "bur", 
  848: "fac", 
  849: "whe", 
  850: "important", 
  851: "dar", 
  852: "nine", 
  853: "sat", 
  854: "fic", 
  855: "known", 
  856: "having", 
  857: "against", 
  858: "soon", 
  859: "ety", 
  860: "langu", 
  861: "public", 
  862: "sil", 
  863: "best", 
  864: "az", 
  865: "knew", 
  866:"black", 
  867: "velo", 
  868: "sort", 
  869: "seven", 
  870: "imag", 
  871: "lead", 
  872: "cap", 
  873: "ask", 
  874: "alth", 
  875: "ature", 
  876: "nam", 
  877: "began", 
  878: "white", 
  879: "sent", 
  880: "sound", 
  881: "vir", 
  882: "days", 
  883: "anything", 
  884: "yeah", 
  885: "ub", 
  886: "blo", 
  887: "sun", 
  888: "story", 
  889: "dire", 
  890: "money", 
  891: "trans", 
  892: "mil", 
  893: "org", 
  894: "grow", 
  895: "cord", 
  896: "pped", 
  897: "cus", 
  898: "spo", 
  899: "sign",
  900: "beaut", 
  901: "goodbye", 
  902: "inde", 
  903: "large", 
  904: "question", 
  905: "often", 
  906: "hour", 
  907: "que", 
  908: "pur", 
  909: "town", 
  910: "ield", 
  911: "coming", 
  912: "door", 
  913: "lig", 
  914: "ling", 
  915: "incl", 
  916: "partic", 
  917: "keep", 
  918: "engl", 
  919: "move", 
  920: "later", 
  921: "ants", 
  922: "food", 
  923: "lights", 
  924: "bal", 
  925: "words", 
  926: "list", 
  927: "aw", 
  928: "allow", 
  929: "aren", 
  930: "pret", 
  931: "tern", 
  932: "today", 
  933: "believe", 
  934: "almost", 
  935: "bir", 
  936: "word", 
  937: "possible", 
  938: "ither", 
  939: "case", 
  940: "ried", 
  941: "ural", 
  942: "round", 
  943: "twent", 
  944: "develo", 
  945: "plain", 
  946: "ended", 
  947: "iting", 
  948: "chang", 
  949: "sc", 
  950: "boy", 
  951: "gy", 
  952: "since", 
  953: "ones", 
  954: "suc", 
  955: "cas", 
  956: "national", 
  957: "plac", 
  958: "teen", 
  959: "pose", 
  960: "started", 
  961: "mas", 
  962: "fi", 
  963: "fif", 
  964: "afr", 
  965: "fully", 
  966: "grou", 
  967: "wards", 
  968: "girl", 
  969: "e", 
  970: "t", 
  971: "a", 
  972: "o", 
  973: "i", 
  974: "n", 
  975: "s", 
  976: "h", 
  977: "r", 
  978: "l", 
  979: "d", 
  980: "u", 
  981: "c", 
  982: "m", 
  983: "w", 
  984: "f", 
  985: "g", 
  986: "y", 
  987: "p", 
  988: "b", 
  989: "v", 
  990: "k", 
  991: "'", 
  992: "x", 
  993: "j", 
  994: "q", 
  995: "z", 
  996: "-", 
  997: "2", 
  998: " "
};

var max_idx;
var string_element = "";
var string_idx = [];
var complete_sentence = "";
var for_string = [];

for(var i=0; i<frames; i++){
    max_idx = indexOfMax(probabilities_matrix[i]);
    string_element = dict[max_idx];
    string_idx.push(string_element);
    if (string_element == "2"){
        try{
            var prev = for_string[-1];
            for_string[i] = '$';
            for_string[i] = prev;
            continue;
        }
        catch(err){
            for_string[i] = ' ';
            continue;
        }
        
    }
    if(string_element != "_"){
        for_string[i] = string_element;
    }
}
var nonull_arr = [];
var count = 0;
for(i=0; i<for_string.length; i++){
    if(for_string[i]!=null){
        if(count == 0){
            nonull_arr[count] = for_string[i];
            count = count + 1;
        }
        nonull_arr[count] = for_string[i];
        count = count + 1;
    }
}

var duplicate_arr = JSON.parse(JSON.stringify(nonull_arr));
duplicate_arr.push(null);
var clean_arr = [];
count = 0;

for(i=0;i<duplicate_arr.length;i++){
    if(duplicate_arr[i]!=null){
        if(nonull_arr[i]!=duplicate_arr[i+1]){
            //no duplicate
            if(count == 0){
                clean_arr[count] = nonull_arr[i];
            }
            clean_arr[count] = nonull_arr[i];
            count = count + 1;
        }
    }
}
complete_sentence = clean_arr.join("").toString();
var output_text = "";

if(complete_sentence==""){
    output_text = "Unable to perform speech recognition";
}
else if(complete_sentence==" "){
    output_text = "only space is detected";
}
else{
    output_text = complete_sentence;
}

msg.Text_speech = output_text;
return {msg: msg, metadata: metadata, msgType: msgType};