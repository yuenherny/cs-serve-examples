{
  "alias": "recording_audio",
  "name": "Record audio",
  "descriptor": {
    "type": "latest",
    "sizeX": 9.5,
    "sizeY": 7,
    "resources": [],
    "templateHtml": " <div fxFlex fxLayout=\"column\" style=\"height: 100%;\"\r\n     fxLayoutAlign=\"center stretch\">\r\n    <p>Record speech</p>\r\n    <audio id=\"audio_recorder\" controls></audio>\r\n    <p>Play speech</p>\r\n    <audio id=\"player\" controls></audio> \r\n </div>",
    "templateCss": "#container {\n    overflow: auto;\n}\n\n.tbDatasource-container {\n    margin: 5px;\n    padding: 8px;\n}\n\n.tbDatasource-title {\n    font-size: 1.200rem;\n    font-weight: 500;\n    padding-bottom: 10px;\n}\n\n.tbDatasource-table {\n    width: 100%;\n    box-shadow: 0 0 10px #ccc;\n    border-collapse: collapse;\n    white-space: nowrap;\n    font-size: 1.000rem;\n    color: #757575;\n}\n\n.tbDatasource-table td {\n    position: relative;\n    border-top: 1px solid rgba(0, 0, 0, 0.12);\n    border-bottom: 1px solid rgba(0, 0, 0, 0.12);\n    padding: 0px 18px;\n    box-sizing: border-box;\n}",
    "controllerScript": "self.onInit = function() {\n\n    self.ctx.$scope.data = self.ctx.defaultSubscription\n         .data;\n    \n    const handleSuccess = function(stream) {\n        \n        //connect to audio player\n        let audio = document.querySelector('audio')\n        \n        if (\"srcObject\" in audio) {\n            audio.srcObject = stream;\n        }\n        else {   // Old version\n            audio.src = window.URL.createObjectURL(stream);\n        }\n        \n        let playAudio = document.getElementById('player');\n        \n        let mediaRecorder = new MediaRecorder(stream);\n        // Pass the audio stream \n        \n        //if clicking audio player recorder\n        audio_recorder.addEventListener(\"play\", function () {\n            mediaRecorder.start();\n            audio.play();\n            console.log(mediaRecorder.state);\n        });\n\n        //if clicking pause on audio recorder\n        audio_recorder.addEventListener(\"pause\", function () {\n            mediaRecorder.stop();\n            audio.pause();\n            console.log(mediaRecorder.state);\n        });\n       \n       // Chunk array to store the audio data \n        var dataArray = []; \n        \n        // If audio data available then push it to the chunk array\n        mediaRecorder.ondataavailable = function (ev) {\n          dataArray.push(ev.data);\n        }\n        \n        // Convert the audio data in to blob after stopping the recording\n        mediaRecorder.onstop = function (ev) {\n  \n          // blob of type mp3/wav\n          var audioData = new Blob(dataArray, \n                    {type:'audio/*'});\n            \n          // After fill up the chunk array make it empty\n          dataArray = [];\n          // Creating audio url with reference \n          // of created blob named 'audioData'\n          var audioSrc = window.URL\n              .createObjectURL(audioData);\n  \n          // Pass the audio url to the 2nd video tag\n          playAudio.src = audioSrc;\n          //Pass data to server\n          var audioCtx = new AudioContext({sampleRate: 16000})\n          \n            var request = new XMLHttpRequest();\n            request.open('GET', audioSrc, true);\n            request.responseType = 'arraybuffer';\n            request.onload = function() {\n                var audio_Data = request.response;\n                audioCtx.decodeAudioData(audio_Data, function(buffer) {\n                    var myBuffer = buffer;\n                    var audio_data = myBuffer.getChannelData(0);\n                    var audio_array = []; \n                    for(var i=0;i<audio_data.length;i++){\n                        audio_array.push(parseFloat(audio_data[i]*32767));\n                    }\n                    console.info(\"audio array\",audio_array);\n                    self.ctx.deviceService\n                        .getDeviceCredentials(self.ctx\n                            .datasources[0].entityId)\n                        .subscribe(function(response) {\n                            url = \"/api/v1/\" + response.credentialsId + \"/telemetry\";\n                            data = {\n                                \"input\": audio_array\n                            };\n                            \n                            console.log(\"widget record audio is running\");\n                            $.ajax({\n                                    url: url,\n                                    type: 'post',\n                                    data: JSON.stringify(data),\n                                    headers: {\n                                        'Content-Type': 'application/json'\n                                    },\n                                    dataType: 'json',\n                                    success: function(postResponse) {\n                                        console.info(\"telemetry done. \" + postResponse);\n                                    }\n                                });\n                        });\n                },\n                function(e){\"Error with decoding audio data\" + e.error});\n            }\n            request.send();\n            console.log(\"Server should receive data\");\n        }\n    };\n\n    navigator.mediaDevices.getUserMedia({ audio: true })\n        .then(handleSuccess).catch(function (err) {\n            console.log(err.name, err.message);\n      });\n}\n\nself.onDataUpdated = function() {\n}\n\nself.onResize = function() {\n}\n\nself.onDestroy = function() {\n}",
    "settingsSchema": "{}",
    "dataKeySettingsSchema": "{}\n",
    "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Record audio\"}"
  },
  "image": "data:image/jpeg;base64,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",
  "description": "Capture audio from microphone to a rule chain input"
}